# Building and searching spectral archive

## Compile from source code

Using the following command to compile the code. 

### Prerequisites

```bash
./install_prerequisites.bash
```

Install cmake version >= 3.20. The default version of Ubuntu 20.04 is cmake 3.16. We can update it using the following script.
```bash
# the following bash commands is from:
# https://www.linuxcapable.com/install-cmake-on-ubuntu-20-04-lts/

sudo apt install build-essential checkinstall zlib1g-dev libssl-dev -y
wget https://github.com/Kitware/CMake/releases/download/v3.22.2/cmake-3.22.2.tar.gz
tar -zxvf cmake-3.22.2.tar.gz
cd cmake-3.22.2
sudo ./bootstrap
sudo make
sudo make install
cd ..
```

Install faiss-1.7.1. This faiss library requires cmake version >=3.20.
```bash
cd ./faiss-1.7.1
./compile.bash
cd ..
```

### Compile spectral archive tool
From the source code folder, run the following scripts. 
```bash
# to have a clean start
./cleanMake.bash
# compile spectral archive tool.
./compile.bash
```

## Usage
### Build archive
#### Add MS data files
First create a text file, mzxmllist, which contains a list of mzXML files to initialize a spectral archive. 
```bash
$ cat mzxmllist
Adult_Adrenalgland_Gel_Elite_49_f01.mzXML
Adult_Adrenalgland_Gel_Elite_49_f02.mzXML
Adult_Adrenalgland_Gel_Elite_49_f03.mzXML
Adult_Adrenalgland_Gel_Elite_49_f04.mzXML
Adult_Adrenalgland_Gel_Elite_49_f05.mzXML
Adult_Adrenalgland_Gel_Elite_49_f06.mzXML
Adult_Adrenalgland_Gel_Elite_49_f07.mzXML
Adult_Adrenalgland_Gel_Elite_49_f08.mzXML
Adult_Adrenalgland_Gel_Elite_49_f09.mzXML
Adult_Adrenalgland_Gel_Elite_49_f10.mzXML
Adult_Adrenalgland_Gel_Elite_49_f11.mzXML
Adult_Adrenalgland_Gel_Elite_49_f12.mzXML
Adult_Adrenalgland_Gel_Elite_49_f13.mzXML
Adult_Adrenalgland_Gel_Elite_49_f14.mzXML
Adult_Adrenalgland_Gel_Elite_49_f15.mzXML
Adult_Adrenalgland_Gel_Elite_49_f16.mzXML
Adult_Adrenalgland_Gel_Elite_49_f17.mzXML
Adult_Adrenalgland_Gel_Elite_49_f18.mzXML
Adult_Adrenalgland_Gel_Elite_49_f19.mzXML
Adult_Adrenalgland_Gel_Elite_49_f20.mzXML
Adult_Adrenalgland_Gel_Elite_49_f21.mzXML
Adult_Adrenalgland_Gel_Elite_49_f22.mzXML
Adult_Adrenalgland_Gel_Elite_49_f23.mzXML
Adult_Adrenalgland_Gel_Elite_49_f24.mzXML

```
Then run the following command to build a spectral archive
```bash
SpectralArchive/build/bin/fastcgi_similarity.fcgi  -m mzxmllist
```
#### Add search results
The spectral archive should be properly annotated. Currently, it supports the following input format.
- .pep.xml file generated by xinteract or search engine (e.g. Comet)
- spectral library, text foramt, sptxt

Run the following command to update the annotation. 
```
SpectralArchive/build/bin/fastcgi_similarity.fcgi  -m mzxmllist --update --updategt <input>.pep.xml
```

### Add new MS data file
The spectral archive can be expanded to include more and more MS data file. Run the following command to add a new mzXML file.
```bash
SpectralArchive/build/bin/fastcgi_similarity.fcgi  -m mzxmllist --update --updaterawdata <input>.mzXML
```
Currently, it supports the following input formats of MS data file.
- mzXML
- mzML
- sptxt

### Search archive
#### Search a given mzXML file
Run the following command to search a data file. 

```bash
SpectralArchive/build/bin/fastcgi_similarity.fcgi  -m mzxmllist --inputsource cmd --datafile <input>.mzXML
```




